<!DOCTYPE html>
<html>
<title>Hackney Playbus Admin</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="static/css/w3.css">
<link rel="stylesheet" href="static/css/animate.min.css">
<link rel="stylesheet" href="static/css/w3-theme-yellow.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="apple-touch-icon" sizes="57x57" href="static/img/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="static/img/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="static/img/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="static/img/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="static/img/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="static/img/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="static/img/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="static/img/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="static/img/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="static/img/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="static/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="static/img/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="static/img/favicon-16x16.png">
<link rel="manifest" href="static/js/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="static/img/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="static/js/masked.min.js"></script>
<script src="static/js/requests.js"></script>
<script src="static/js/submitform.js"></script>
<script src="static/js/date.js"></script>
<script src="static/js/oms.min.js"></script>

<style>
html,body,h1,h2,h3,h4,h5,h6 {font-family: "Roboto", sans-serif}
</style>
<body>

<!-- Navbar -->
<div id="nav-placeholder"></div>

<!-- Sidebar -->
<div id="sidebar-placeholder"></div>

<!-- Main content: shift it to the right by 250 pixels when the sidebar is visible -->
<div class="w3-main" style="margin-left:150px">
    <div class="w3-row w3-padding-64">
        <div  class="w3-half w3-container" style="margin-top:16px">
            <div class="w3-card-4" style="margin-left:8px">
                <i class="w3-xlarge fa fa-user-plus w3-right w3-text-teal w3-button" onclick='displayModal("child-modal");' style="padding:6px 12px;"></i>
                <h3 class="w3-center w3-text-teal">Children</h3>
                <div id='child-card-placeholder'></div>
            </div>
        </div>
        <div class="w3-half w3-container" style="margin-top:16px">
            <div class="w3-card-4" style="margin-left:8px">
                <i class="w3-xlarge fa fa-user-plus w3-right w3-text-teal w3-button"  onclick='displayModal("carer-modal");' style="padding:6px 12px;"></i>
                <h3 class="w3-center w3-text-teal">Carers</h3>
                <div id='carer-card-placeholder'></div>
            </div>
        </div>
  </div>
  <div class="w3-row w3-padding-8">
      <div class="w3-half w3-container">
        <div id="map" style="width:100%; height:400px;"></div>
      </div>
      <div class="w3-half w3-container">
        <div class="w3-card-4" style="margin-left:8px">
            <i class="w3-xlarge fa fa-plus-square w3-right w3-text-teal w3-button"  onclick='displayModal("note-modal");' style="padding:6px 12px;"></i>
            <h3 class="w3-center w3-text-teal">Notes</h3>
            <div id='note-card-placeholder'></div>
        </div>
      </div>
  </div>
  <div class="w3-row w3-padding-8">      
      <div class="w3-container">
        <div class="w3-card-4" style="margin-left:8px">
            <i class="w3-xlarge fa fa-plus-square w3-right w3-text-teal w3-button"  onclick='displayModal("referral-modal");' style="padding:6px 12px;"></i>
            <h3 class="w3-center w3-text-teal">Referrals</h3>
            <div id='referral-card-placeholder'></div>
        </div>
      </div>
  </div>
    <br/>
    <br/>
</div>
<!-- END MAIN -->
<div id="child-modal" class="w3-modal">
    <div class="w3-modal-content">
        <div class="w3-container" style='padding-left:0px;padding-right:0px;'>
            <div id="child-placeholder"></div>
        </div>
    </div>
</div>

<div id="delete-modal" class="w3-modal">
    <div class="w3-modal-content">
        <div class="w3-container w3-card-4 w3-center w3-text-teal w3-padding-16">
            <h3>Are you sure you want to delete?</h3>
            <input class="w3-button w3-right w3-border" type="submit" value="No" onclick="document.getElementById('delete-modal').style.display = 'none';">
            <input id='delete-btn' class="w3-button w3-left w3-border" type="submit" value="Yes">
        </div>
    </div>
</div>

<div id="carer-modal" class="w3-modal">
    <div class="w3-modal-content">
        <div class="w3-container" style='padding-left:0px;padding-right:0px;'>
            <div id="carer-placeholder"></div>
        </div>
    </div>
</div>

<div id="note-modal" class="w3-modal">    
    <div class="w3-modal-content">
        <div class="w3-container" style='padding-left:0px;padding-right:0px;'>
            <div id="note-placeholder"></div>
        </div>
    </div>
</div>

<div id='location-modal' class="w3-modal">
    <div class="w3-modal-content">
        <div class="w3-container" style='padding-left:0px;padding-right:0px;'>
            <div id='location-list-placeholder'></div>
        </div>
    </div>
</div>

<div id='visit-modal' class="w3-modal">
    <div class="w3-modal-content">
        <div class="w3-container" style='padding-left:0px;padding-right:0px;'>
            <div id='visit-placeholder'>
                <div class='w3-container w3-card-4 w3-margin'>
                    <h3 id='visit-title' class="w3-text-teal">Visits</h3>    
                    <div id='visit-list'></div>
                </div>
                <div id='visit-instance' style='display:none;'>
                    <i id='visit-elm' class='visit-element'></i>
                    <i class="w3-text-teal w3-button visit-delete-button"  style="padding:16px 12px;">(delete)</i>
                    <br/>
                </div>
            </div>
        </div>
    </div>
</div>

<div id='change-visit-modal' class="w3-modal">
    <div class="w3-modal-content">
        <div class="w3-container" style='padding-left:0px;padding-right:0px;'>
            <div id='change-visit-form' class="w3-container w3-card-4 w3-text-yellow" style="padding-bottom: 10px;">
                <h2 id='visit-reg-header' class="w3-center w3-text-teal">Set Default Visit</h2>          
                <div class="w3-row w3-section">
                    <div class="w3-col" style="width:50px"><i class="w3-xxlarge fa fa-map"></i></div>
                        <div class="w3-rest">
                            <select class="w3-input w3-border w3-round-medium location-dropdown" id='visit-location' name="visit-location" type="text" placeholder="Location">
                                <option value="" disabled selected hidden>Location</option>
                            </select>
                        </div>
                    </div>
                <div class="w3-row w3-section">
                <div class="w3-col" style="width:50px"><i class="w3-xxlarge fa fa-"></i></div>
                    <div class="w3-rest">
                        <select class="w3-input w3-border w3-round-medium project-dropdown" id='visit-project' name="visit-project" type="text" placeholder="Project">
                            <option value="" disabled selected hidden>Project</option>
                        </select>
                    </div>
                </div>
                <div class="w3-row w3-section">
                <div class="w3-col" style="width:50px"><i class="w3-xxlarge fa fa-calendar"></i></div>
                    <div class="w3-rest">
                        <input class="w3-input w3-border w3-round-medium date-input" id='visit-date'  name="visit-date" type="date" placeholder="Visit Date" min="1900-01-01" max="2099-04-30">
                        <i class="w3-right w3-text-teal w3-small" style='margin-right:3px;'>optional</i>
                    </div>
                </div>
                <div id='visit-error' class='w3-left w3-text-red'></div>
                <input onclick='setDefaultVisit();' class="w3-button w3-right w3-text-teal w3-border" type="submit" value="Set Default Visit" style='margin-left:10px;'>
                <input id='visit-submit' onclick='addAndSetVisit(event, this);' class="w3-button w3-right w3-text-teal w3-border" type="submit" value="Add Visit">
            </div>
        </div>
    </div>
</div>

<div id='project-modal' class="w3-modal">
    <div class="w3-modal-content">
        <div class="w3-container" style='padding-left:0px;padding-right:0px;'>
            <div id='project-list-placeholder'></div>
        </div>
    </div>
</div>

<div id="referral-modal" class="w3-modal">
    <div class="w3-modal-content">
        <div class="w3-container" style='padding-left:0px;padding-right:0px;'>
            <div id="referral-placeholder"></div>
        </div>
    </div>
</div>

<div id='child-card' class="w3-card-4" style='display:none;'>

    <header class="w3-container w3-text-teal w3-theme-l2">        
        <i class="w3-xlarge fa fa-times w3-right w3-text-teal w3-button delete-button" onclick='displayModal("delete-modal", this);' style="padding:16px 12px;"></i>
        <i class="w3-xlarge fa fa-edit w3-right w3-text-teal w3-button edit-button" onclick='displayModal("child-modal", this);' style="padding:16px 12px;"></i>        
        <h4 class='child-name'></h4>
    </header>
    <div class='w3-text-teal w3-margin'>
        <table style='margin-left:auto;margin-right:auto;text-decoration:none;'>
            <tr>
                <td>
                    <input type="submit" id='visit-row' onclick='addVisit(event, this);' class='w3-button w3-center w3-border w3-small visit-row' value='Add Visit'>
                </td>
                <td>
                    <div class="visit-location w3-small">set location</div>
                    <div class="visit-project w3-small">  set project</div>
                </td>
            </tr>
        </table>
        <div id='change-visit' class='change-visit w3-hover-opacity w3-center w3-small jono-button' onclick='displayModal("change-visit-modal", this);'>Set Default Visit</div>
    </div>    
    <div class="w3-container">
        <table class="w3-table w3-text-gray">          
            <tr>
            <td>Date of Birth:</td>
            <td class='child-dob'></td>                             
            </tr>
            <tr>
            <td>Gender:</td>
            <td class='child-gender'></td>                             
            </tr>
            <tr>
            <td>Ethnicity:</td>
            <td class='child-ethnicity'></td>                             
            </tr>                          
            <tr>
            <td>First Seen:</td>
            <td class='child-firstseen'></td>                             
            </tr>
            <tr>
            <td>Photo Consent:</td>
            <td class='child-photoconsent'></td>                             
            </tr>
            <tr>
            <td>Number of Visits:</td>
            <td class='child-numvisits'></td>                             
            </tr>
        </table>
        <hr>  
    </div>
</div>

<div id='carer-card' class="w3-card-4" style='display:none;'>
    <header class="w3-container w3-text-teal w3-theme-l2">   
        <i class="w3-xlarge fa fa-times w3-right w3-text-teal w3-button delete-button" onclick='displayModal("delete-modal", this);' style="padding:16px 12px;"></i>
        <i class="w3-xlarge fa fa-edit w3-right w3-text-teal w3-button edit-button" onclick='displayModal("carer-modal", this);' style="padding:16px 12px;"></i>             
        <h4 class='carer-name'></h4>
    </header>

    <div class='w3-text-teal w3-margin'>
        <table style='margin-left:auto;margin-right:auto;text-decoration:none;'>
            <tr>
                <td>
                    <input type="submit" id='visit-row' onclick='addVisit(event, this);' class='w3-button w3-center w3-border w3-small visit-row' value='Add Visit'>
                </td>
                <td>
                    <div class="visit-location w3-small">set location</div>
                    <div class="visit-project w3-small">  set project</div>
                </td>
            </tr>
        </table>
        <div id='change-visit' class='change-visit w3-hover-opacity w3-center w3-small jono-button' onclick='displayModal("change-visit-modal", this);'>Set Default Visit</div>
    </div> 
    
    <div class="w3-container">
        <table class="w3-table w3-text-gray">          
            <tr>
            <td>Date of Birth:</td>
            <td class='carer-dob'></td>                             
            </tr>
            <tr>
            <td>Gender:</td>
            <td class='carer-gender'></td>                             
            </tr>
            <tr>
            <td>Ethnicity:</td>
            <td class='carer-ethnicity'></td>                             
            </tr>                          
            <tr>
            <td>First Seen:</td>
            <td class='carer-firstseen'></td>                             
            </tr>
            <tr>
            <td>Photo Consent?:</td>
            <td class='carer-photoconsent'></td>                             
            </tr>
            <tr>
            <td>Address:</td>
            <td class='carer-address'></td>                             
            </tr>
            <tr>
            <td>Postal Code:</td>
            <td class='carer-postalcode'></td>                             
            </tr>
            <tr>
            <td>City:</td>
            <td class='carer-city'></td>                             
            </tr>
            <tr>                
            <td>Phone:</td>
            <td class='carer-phone'></td>
            </tr>
            <tr>
            <td>Email:</td>
            <td class='carer-email'></td>
            </tr>
            <tr>
            <td>Benefits:</td>
            <td class='carer-benefits'></td>
            </tr>
            <tr>
            <td>Lone Carer?:</td>
            <td class='carer-lonecarer'></td>
            </tr>
            <tr>
            <td>Number of Visits:</td>
            <td class='carer-numvisits'></td>                             
            </tr>
        </table>        
        <hr>  
    </div>
</div>

<div id='note-card' class="w3-border-top" style='display:none;'>
    <div class="w3-container w3-text-dark-grey" style='padding-top:16px;'>
        <div class='note-text'></div>
        <hr> 
        <div class='w3-text-grey'>
            By <i class='note-author'></i> at <i class='note-timestamp'></i><br/><br/>
        </div>
    </div>
</div>

<div id='referral-card' class="w3-border-top" style='display:none;'>
    <div class="w3-container w3-text-dark-grey" style='padding-top:16px;'>        
        <i class='referral-service'></i>
        <i class="w3-large fa fa-times w3-text-teal w3-button referral-delete-button" onclick='displayModal("delete-modal", this);'  style="padding:16px 12px;"></i>
    </div>
</div>

<script>
  // Add in the sidebar and navigation bar. These will be common to all pages.
  $(function(){    
    $("#sidebar-placeholder").load("static/html/sidebar.html");
    $("#nav-placeholder").load("static/html/navbar.html");   
    $("#child-placeholder").load("static/html/addchild.html", function(){
        document.getElementById('child-before').style.display = 'none';
        document.getElementById('child-form').classList.remove('w3-twothird');
    });
    $("#carer-placeholder").load("static/html/addcarer.html", function(){
        document.getElementById('carer-before').style.display = 'none';
        document.getElementById('carer-form').classList.remove('w3-twothird');
    });      
    $("#note-placeholder").load("static/html/addnote.html");
    $("#location-list-placeholder").load("static/html/locationlist.html", function(){
        var locelm = document.getElementById('location-list');        
        locelm.onclick = function(e) {
            e=e||event; // IE sucks
            var target = e.target||e.srcElement; // and sucks again

            if (target && target.getAttribute('id') =='location-elm') {
                target = target.parentNode;
            }

            if (target && target.getAttribute('id') =='location-instance') {

                var elems = document.getElementsByClassName('location-element');                
                var locstr = target.getAttribute('data-location');
                
                var modal = document.getElementById('location-modal');
                modal.style.display = "none";
            }
            return false
        };           
    });
    $("#project-list-placeholder").load("static/html/projectlist.html", function(){
        var locelm = document.getElementById('project-list');        
        locelm.onclick = function(e) {
            e=e||event; // IE sucks
            var target = e.target||e.srcElement; // and sucks again

            if (target && target.getAttribute('id') =='project-elm') {
                target = target.parentNode;
            }

            if (target && target.getAttribute('id') =='project-instance') {

                var elems = document.getElementsByClassName('project-element');                
                var locstr = target.getAttribute('data-location');
                var loc = JSON.parse(locstr);                          
                setCookie('last_project', locstr);                
                setLastLocationText();
                var modal = document.getElementById('project-modal');
                modal.style.display = "none";
            }
            return false
        };           
    });

    $("#referral-placeholder").load("static/html/servicelist.html", function(){
        var locelm = document.getElementById('service-list');        
        locelm.onclick = function(e) {
            e=e||event; // IE sucks
            var target = e.target||e.srcElement; // and sucks again
            if (target && target.getAttribute('id') =='service-elm') {

                var elems = document.getElementsByClassName('service-element');                
                var locstr = target.getAttribute('data-location');
                var loc = JSON.parse(locstr);                          
                
                submitReferral({
                    family_id: familyId,
                    service_id: loc.service_id
                }, function(){location.reload();});
            }
            return false
        };           
    });
  });  
   
  setLastLocationText(); 
  function setLastLocationText(){ 
    var lastlocstr = getCookie('last_location');
    var lastprojstr = getCookie('last_project');
    
    if (lastlocstr && lastlocstr != "null") {
        var loc = JSON.parse(lastlocstr);
        var visitbuttons = document.getElementsByClassName('visit-location');
        for (var ii = 0; ii < visitbuttons.length; ++ii) {
            visitbuttons[ii].innerText = "  "+loc.name;
        }
    }
    if (lastprojstr && lastprojstr != "null") {
        proj = JSON.parse(lastprojstr);
        var visitbuttons = document.getElementsByClassName('visit-project');
        for (var ii = 0; ii < visitbuttons.length; ++ii) {
            visitbuttons[ii].innerText = "  "+proj.name;
        }
    }
  }


  var family = {};
  var familyId = getParameterByName('familyId');    
  getFamily(familyId).then(function(response) {
      if (response.status >= 200 && response.status <= 299) {
        response.json().then(function(json){
            family = json;
            if (json.children) {
                var origChildCard = document.getElementById('child-card');
                var childAnchor = document.getElementById('child-card-placeholder');
                for (var ii = 0; ii < json.children.length; ++ii) {
                    var newCard = origChildCard.cloneNode(true);                
                    newCard.querySelector('.child-name').innerText = json.children[ii].name;
                    var jsonData = JSON.stringify(json.children[ii]);
                    newCard.querySelector('.visit-row').setAttribute('data-location', jsonData);
                    newCard.querySelector('.change-visit').setAttribute('data-location', jsonData);
                    newCard.querySelector('.delete-button').setAttribute('data-location', jsonData);
                    newCard.querySelector('.edit-button').setAttribute('data-location', jsonData);
                    displayField(newCard.querySelector('.child-dob'), timeParser(json.children[ii].date_of_birth, 'yyyy-MM-dd', 'dd/MM/yyyy'));                    
                    displayField(newCard.querySelector('.child-gender'), json.children[ii].gender);
                    displayField(newCard.querySelector('.child-ethnicity'), json.children[ii].ethnicity);
                    displayField(newCard.querySelector('.child-firstseen'), timeParser(json.children[ii].first_seen));                    
                    displayField(newCard.querySelector('.child-photoconsent'), json.children[ii].photo_consent);
                    var numVisit = newCard.querySelector('.child-numvisits');
                    displayField(numVisit, json.children[ii].number_of_visits);
                    numVisit.setAttribute('data-location', jsonData);
                    numVisit.onclick = (function(nv) {
                       return function() {
                           displayModal('visit-modal', nv);
                       };
                    }(numVisit));
                    numVisit.classList.add('w3-button');
                    numVisit.classList.add('w3-text-teal');

                    newCard.style = '';
                    childAnchor.appendChild(newCard);
                    
                }
            }
            if (json.carers) {
                var origCarerCard = document.getElementById('carer-card');
                var carerAnchor = document.getElementById('carer-card-placeholder');                                              
                for (var ii = 0; ii < json.carers.length; ++ii) {                
                    var newCard = origCarerCard.cloneNode(true);                
                    newCard.querySelector('.carer-name').innerText = json.carers[ii].name;
                    var jsonData = JSON.stringify(json.carers[ii]);
                    newCard.querySelector('.visit-row').setAttribute('data-location', jsonData);
                    newCard.querySelector('.change-visit').setAttribute('data-location', jsonData);
                    newCard.querySelector('.delete-button').setAttribute('data-location', jsonData);
                    newCard.querySelector('.edit-button').setAttribute('data-location', jsonData);
                    displayField(newCard.querySelector('.carer-dob'), timeParser(json.carers[ii].date_of_birth, 'yyyy-MM-dd', 'dd/MM/yyyy'));                    
                    displayField(newCard.querySelector('.carer-gender'), json.carers[ii].gender);
                    displayField(newCard.querySelector('.carer-ethnicity'), json.carers[ii].ethnicity);                
                    displayField(newCard.querySelector('.carer-firstseen'), timeParser(json.carers[ii].first_seen));                
                    displayField(newCard.querySelector('.carer-address'), json.carers[ii].address);
                    displayField(newCard.querySelector('.carer-postalcode'), json.carers[ii].postal_code);
                    displayField(newCard.querySelector('.carer-city'), json.carers[ii].city);
                    displayField(newCard.querySelector('.carer-phone'), json.carers[ii].phone);
                    displayField(newCard.querySelector('.carer-email'), json.carers[ii].email);
                    displayField(newCard.querySelector('.carer-benefits'),json.carers[ii].benefits);
                    displayField(newCard.querySelector('.carer-lonecarer'), json.carers[ii].lone_carer);
                    displayField(newCard.querySelector('.carer-photoconsent'), json.carers[ii].photo_consent);
                    var numVisit = newCard.querySelector('.carer-numvisits');
                    displayField(numVisit, json.carers[ii].number_of_visits);
                    numVisit.setAttribute('data-location', jsonData);
                    numVisit.onclick = (function(nv) {
                       return function() {
                           displayModal('visit-modal', nv);
                       };
                    }(numVisit));
                    numVisit.classList.add('w3-button');
                    numVisit.classList.add('w3-text-teal');
                    newCard.style = '';
                    carerAnchor.appendChild(newCard);                
                }                           
            }
            if (json.notes) {
                var origNoteCard = document.getElementById('note-card');
                var noteAnchor = document.getElementById('note-card-placeholder');                                
                for (var ii = 0; ii < json.notes.length; ++ii) {                
                    var newCard = origNoteCard.cloneNode(true);                
                    newCard.querySelector('.note-text').innerText = json.notes[ii].note;
                    displayField(newCard.querySelector('.note-author'), json.notes[ii].note_taker);
                    displayField(newCard.querySelector('.note-timestamp'), timeParser(json.notes[ii].timestamp));
                    newCard.style = '';
                    noteAnchor.appendChild(newCard);                
                }
            }
            if (json.referrals) {
                var origRefCard = document.getElementById('referral-card');
                var refAnchor = document.getElementById('referral-card-placeholder');                                
                for (var ii = 0; ii < json.referrals.length; ++ii) {                
                    var newCard = origRefCard.cloneNode(true);                
                    newCard.querySelector('.referral-service').innerText = json.referrals[ii].service.name;
                    newCard.querySelector('.referral-delete-button').setAttribute('data-location', JSON.stringify(json.referrals[ii]));
                    newCard.style = '';
                    refAnchor.appendChild(newCard);                
                }
            }
            loadScript();
        });        
      }
		}).catch(function(err) {
			console.log("Could not update child", err)
		});
            
    function displayModal(modal, from) {
        var modalElem = document.getElementById(modal);
        updateModal(modal, modalElem, from);
        modalElem.style.display = "block";

    }
    window.onclick = function(event) {
        closeModals(event);
    }

    function closeModals(event) {
        var modals = document.getElementsByClassName('w3-modal');
        for(var ii = 0; ii < modals.length; ++ii){
            if (event.target == modals[ii]) {
                modals[ii].style.display = "none";                
            }
        }
    }

    function updateModal(type, modalElem, from) {
        
        switch (type) {
            case 'change-visit-modal':
                var sub = document.getElementById('visit-submit');
                var cdStr = from.getAttribute('data-location');
                if (!cdStr) {
                    return
                }
                
                sub.setAttribute('data-location', cdStr);
            break;
            case 'child-modal':
                if (from) {
                    populateChild(modalElem, from);                    
                } else {
                    emptyChild(modalElem);
                }
            break;
            case 'carer-modal':
                if (from) {
                    populateCarer(modalElem, from);
                } else {
                    emptyCarer(modalElem);
                }
            break;
            case 'delete-modal':
                var cf = modalElem.querySelector("#delete-btn");
                cf.removeAttribute('onclick');
                var cdStr = from.getAttribute('data-location');
                if (!cdStr) {
                    return
                }
                var cd = JSON.parse(cdStr);
                if (!cd) {
                    return
                }

                var entity = '';
                var entityId = '';
                if (cd.child_id) {
                    entity = 'child';
                    entityId = cd.child_id;
                } else if (cd.carer_id) {
                    entity = 'carer';
                    entityId = cd.carer_id;
                } else if (cd.referral_id) {
                    entity = 'referral';
                    entityId = cd.referral_id;
                }                
                cf.onclick = function(event){
                    deleteEntity(entity, entityId);
                };
            break;
            case "visit-modal":
                var list = document.getElementById('visit-list');
                
                while (list.hasChildNodes()) {
                    list.removeChild(list.lastChild);
                }
                var origloc =document.getElementById('visit-instance');
                var cdStr = from.getAttribute('data-location');
                if (!cdStr) {
                    return
                }
                var cd = JSON.parse(cdStr);
                if (!cd) {
                    return
                }        
                for (var ii = 0; ii < family.visits.length; ++ii) {
                    
                    if (cd.child_id) {
                        if (cd.child_id != family.visits[ii].child_id) {
                            continue;
                        }
                        
                    }
                    if (cd.carer_id) {
                        if (cd.carer_id != family.visits[ii].carer_id) {
                            continue;
                        }
                        
                    }
                    var loc = origloc.cloneNode(true);   
                    var visitDelBtn = loc.querySelector('.visit-delete-button');                    
                    var visitId = family.visits[ii].visit_id;
                    visitDelBtn.onclick = (function(visitIdBind) {                        
                        return function() {
                            deleteEntity("visit", visitIdBind);
                        };
                    }(visitId));
                    var nameElm = loc.querySelector('.visit-element');
                    nameElm.innerText = family.visits[ii].location.name;
                    loc.style.display = "block";
                    list.appendChild(loc);
                    
                }
            
            break;
        }
    }

    function populateChild(modalElem, from) {
        var cdStr = from.getAttribute('data-location');
        if (!cdStr) {
            return
        }
        var cd = JSON.parse(cdStr);
        if (!cd) {
            return
        }
        modalElem.querySelector("#reg-header").innerText = 'Edit Child';
        modalElem.querySelector("#child-name").value = cd.name;
        modalElem.querySelector("#child-dob").value = cd.date_of_birth;
        modalElem.querySelector("#child-ethnicity").value = cd.ethnicity;
        modalElem.querySelector("#child-gender").value = cd.gender;
        var cf = modalElem.querySelector("#child-form");
        cf.setAttribute('child_id', cd.child_id);
        cf.removeAttribute('onsubmit');
        cf.onsubmit = function(event){
            submitChild(event, function(json) {
                location.reload();
            });
        };
        
    }

    function emptyChild(modalElem) {
        modalElem.querySelector("#reg-header").innerText = 'Register Your Child';
        modalElem.querySelector("#child-name").value = '';
        modalElem.querySelector("#child-dob").value = '';
        modalElem.querySelector("#child-ethnicity").value = '';
        modalElem.querySelector("#child-gender").value = '';
        var cf = modalElem.querySelector("#child-form");
        cf.removeAttribute('child_id');
        cf.removeAttribute('onsubmit');
        
        cf.onsubmit = function(event){
            submitChild(event);
        };
    }

    function populateCarer(modalElem, from) {
        var cdStr = from.getAttribute('data-location');
        if (!cdStr) {
            return
        }
        var cd = JSON.parse(cdStr);
        if (!cd) {
            return
        }
        modalElem.querySelector("#reg-carer-header").innerText = 'Edit Carer';
        modalElem.querySelector("#carer-name").value = cd.name;
        modalElem.querySelector('#carer-dob').value = cd.date_of_birth;                    
        modalElem.querySelector('#carer-gender').value = cd.gender;
        modalElem.querySelector('#carer-ethnicity').value = cd.ethnicity;                       
        modalElem.querySelector('#carer-address').value = cd.address;
        modalElem.querySelector('#carer-postalcode').value = cd.postal_code;
        modalElem.querySelector('#carer-city').value = cd.city;
        modalElem.querySelector('#carer-phone').value = cd.phone;
        modalElem.querySelector('#carer-email').value = cd.email;
        modalElem.querySelector('#carer-benefits').value = cd.benefits;
        modalElem.querySelector('#carer-lonecarer').checked = cd.lone_carer;        
    
        var cf = modalElem.querySelector("#carer-form");
        cf.setAttribute('carer_id', cd.carer_id);
        cf.removeAttribute('onsubmit');
        cf.onsubmit = function(event){
            submitCarer(event, function(json) {
                location.reload();
            });
        };
    }

    function emptyCarer(modalElem) {
        modalElem.querySelector("#reg-carer-header").innerText = 'Register A Carer';
        modalElem.querySelector("#carer-name").value = '';
        modalElem.querySelector('#carer-dob').value = '';
        modalElem.querySelector('#carer-gender').value = '';
        modalElem.querySelector('#carer-ethnicity').value = '';        
        modalElem.querySelector('#carer-address').value = '';
        modalElem.querySelector('#carer-postalcode').value = '';
        modalElem.querySelector('#carer-city').value = '';
        modalElem.querySelector('#carer-phone').value = '';
        modalElem.querySelector('#carer-email').value = '';
        modalElem.querySelector('#carer-benefits').value = '';
        modalElem.querySelector('#carer-lonecarer').checked = false;        
        var cf = modalElem.querySelector("#carer-form");
        cf.removeAttribute('carer_id');
        cf.removeAttribute('onsubmit');
        
        cf.onsubmit = function(event){
            submitCarer(event);
        };
    }

    function displayField(elem, val) {
        if (typeof val != 'undefined') {
            elem.innerText = val;
        } else {
            elem.innerText = '';
        }
    }

    function timeParser(val, parse, format) {
        if (!parse) {
            parse = "yyyy-MM-ddTHH:mm:ssZ";
        }
        if (!format) {
            format = 'dd/MM/yyyy HH:mm:ss';
        }
        var fs = Date.parseExact(val, parse);
        if (fs) {
            return fs.toString(format)
        }
        return ''
    }

    function loadScript() {
        fetch('/mapskey', {
			method: 'get',
			credentials: "same-origin"			
		}).then(function(response) {
            if (response.status >= 200 && response.status <= 299) {
                response.json().then(function(json){
                    var script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = 'https://maps.googleapis.com/maps/api/js?v=3' + '&key=' + json.map_key +'&callback=initmap'; 
                    document.body.appendChild(script);
                });
            }
        });
    }

    function initmap() {        
        var map = new google.maps.Map(document.getElementById('map'),{
            zoom: 13,        
            scrollwheel: true,
            center: new google.maps.LatLng(51.552744, -0.061378)
        });

        var oms = new OverlappingMarkerSpiderfier(map, { 
            markersWontMove: true, 
            markersWontHide: true,
            basicFormatEvents: true
        });

        var info = new google.maps.InfoWindow();
        var latlngbounds = new google.maps.LatLngBounds();
        if (family.carers) {
            for (var ii = 0; ii < family.carers.length; ++ii) {
                if (family.carers[ii].latitude && family.carers[ii].longitude && family.carers[ii].latitude != 0 && family.carers[ii].longitude != 0) {
                    var familyMark = new google.maps.Marker({
                        position: {lat: family.carers[ii].latitude, lng: family.carers[ii].longitude},
                        map: map
                    });
                    
                    familyMark.setIcon("http://maps.google.com/mapfiles/ms/icons/blue-dot.png");
                    google.maps.event.addListener(map, 'click', function(info) {
                        return function() {info.close();};
                    }(info));
                    google.maps.event.addListener(familyMark, 'spider_click', function(info, marker, name) {
                        return function(){
                            info.setContent("<div>" +
                            "<h4>Carer Home</h4>" +
                            "Name: " + name +
                        "</div>");
                            info.open(map, marker);
                        };
                    }(info, familyMark, family.carers[ii].name));
                    oms.addMarker(familyMark);
                    latlngbounds.extend( familyMark.getPosition() );                    
                }
            }
            map.fitBounds( latlngbounds );
        }
        if (family.visits) {
            for (var ii = 0; ii < family.visits.length; ++ii) {
                if (family.visits[ii].location.latitude && family.visits[ii].location.longitude) {
                    var visitMark = new google.maps.Marker({
                        position: {lat: family.visits[ii].location.latitude, lng: family.visits[ii].location.longitude},
                        map: map
                    });
                    var name = '';
                    var header = '';
                    if (family.visits[ii].child_id) {
                        for (var jj = 0; jj < family.children.length; ++jj) { 
                            if (family.children[jj].child_id == family.visits[ii].child_id) {
                                header = "Child Visit";
                                name = family.children[jj].name;
                            }
                        }
                    }
                    if (family.visits[ii].carer_id) {
                        for (var jj = 0; jj < family.carers.length; ++jj) { 
                            if (family.carers[jj].carer_id == family.visits[ii].carer_id) {
                                header = "Carer Visit";
                                name = family.carers[jj].name;
                            }
                        }
                    }
                    
                    google.maps.event.addListener(map, 'click', function(info) {
                        return function() {info.close();};
                    }(info));
                    google.maps.event.addListener(visitMark, 'spider_click', function(info, marker,header,name) {
                        return function(){
                            info.setContent("<div>" +
                                "<h4>"+header+"</h4>" +   
                                "Name: " + name +
                            "</div>");
                            info.open(map, marker);
                        };
                    }(info, visitMark, header,name));
                    oms.addMarker(visitMark);

                    latlngbounds.extend( visitMark.getPosition() );
                }
            }
            map.fitBounds( latlngbounds );
        }
        
    }

    function addVisit(e, elm, date) {
            var visit = {}
            var cdstr = elm.getAttribute('data-location');
            var lastlocstr = getCookie('last_location');
            var lastprojstr = getCookie('last_project');
            var cd = JSON.parse(cdstr);
            if (lastlocstr) {
                var loc = JSON.parse(lastlocstr);
                visit.location_id = loc.location_id
            }
            if (lastprojstr) {
                proj = JSON.parse(lastprojstr);
                visit.project_id = proj.project_id
            }
            if (cd.child_id) {
                visit.child_id = cd.child_id;
            }
            if (cd.carer_id) {
                visit.carer_id = cd.carer_id;
            }
            if (cd.family_id) {
                visit.family_id = cd.family_id;
            }
            if (date) {
                visit.date_attended = date + 'T00:00:00Z'
            }            

            submitVisit(visit);
    }

    readLocations().then(function(response) {
      if (response.status >= 200 && response.status <= 299) {
        response.json().then(function(json){
            var lists = document.getElementsByClassName('location-dropdown');
            for (var ii = 0; ii < lists.length; ++ii) {
                var list = lists[ii];
                json.forEach(function(item){
                    var option = document.createElement('option');
                    option.value = JSON.stringify(item);
                    option.innerText = item.name;
                    list.appendChild(option);
                });
            }
        });
      }
    }).catch(function(err) {
        console.log("Could not read location", err)
    });

    readProjects().then(function(response) {
      if (response.status >= 200 && response.status <= 299) {
        response.json().then(function(json){
            var lists = document.getElementsByClassName('project-dropdown');
            for (var ii = 0; ii < lists.length; ++ii) {
                var list = lists[ii];
                json.forEach(function(item){
                    var option = document.createElement('option');
                    option.value = JSON.stringify(item);
                    option.innerText = item.name;
                    list.appendChild(option);
                });
            }
        });
      }
    }).catch(function(err) {
        console.log("Could not read project", err)
    });

    function addAndSetVisit(event, elm) {
        if (!setDefaultVisit()) {
            return
        }

        var vd = document.getElementById("visit-date");        
        addVisit(event, elm, vd.value);
    }

    function setDefaultVisit() {
        var locstr = document.getElementById('visit-location').value;
        if (!locstr) {
            document.getElementById('visit-error').innerText = "Must supply a location";
            return false
        }
        var projstr = document.getElementById('visit-project').value;
        if (!projstr) {
            document.getElementById('visit-error').innerText = "Must supply a project";
            return false
        }
        setCookie('last_location', locstr);
        setCookie('last_project', projstr);
        setLastLocationText();
        document.getElementById("change-visit-modal").style.display = "none";
        return true
    }
</script>

</body>
</html>