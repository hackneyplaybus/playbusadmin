<!DOCTYPE html>
<html>
<title>Hackney Playbus Admin</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="static/css/w3.css">
<link rel="stylesheet" href="static/css/animate.min.css">
<link rel="stylesheet" href="static/css/w3-theme-yellow.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="apple-touch-icon" sizes="57x57" href="static/img/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="static/img/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="static/img/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="static/img/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="static/img/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="static/img/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="static/img/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="static/img/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="static/img/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="static/img/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="static/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="static/img/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="static/img/favicon-16x16.png">
<link rel="manifest" href="static/js/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="static/img/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="static/js/masked.min.js"></script>
<script src="static/js/requests.js"></script>
<script src="static/js/submitform.js"></script>

<style>
html,body,h1,h2,h3,h4,h5,h6 {font-family: "Roboto", sans-serif}
</style>
<body>

<!-- Navbar -->
<div id="nav-placeholder"></div>

<!-- Sidebar -->
<div id="sidebar-placeholder"></div>

<!-- Main content: shift it to the right by 250 pixels when the sidebar is visible -->
<div class="w3-main" style="margin-left:150px">

  <div class="w3-padding-64">
    <div class="w3-container">
      <div class="w3-row">
          <div class="w3-twothird">
            
                <form onsubmit="submitLocation(event);" id='location-form' class="w3-container w3-card-4 w3-text-yellow w3-margin" style="padding-bottom: 10px;">        
                    <i id='location-header-exit' onclick='clearedit();' class="w3-button w3-large fa fa-times w3-right w3-text-teal" style='display: none; margin-top:18px;'> Stop Editing</i>
                    <h2 id='location-header' class="w3-text-teal">Add Location</h2>          
                    <div class="w3-row w3-section">
                        <div class="w3-col w3-center" style="width:50px"><i class="w3-xxlarge fa fa-map-signs"></i></div>
                            <div class="w3-rest">
                                <input class="w3-input w3-border w3-round-medium" name="location-name" id="location-name" type="text" placeholder="Name" required>
                            </div>
                        </div>
                    <div class="w3-row w3-section">
                    <div class="w3-col w3-center" style="width:50px"><i class="w3-xxlarge fa fa-file-text"></i></div>
                        <div class="w3-rest">
                        <textarea class="w3-input w3-border w3-round-medium" id='location-description' name="location-description" placeholder="Description"></textarea>                 
                        </div>
                    </div>
                    <div class="w3-row w3-section">
                    <div class="w3-col w3-center" style="width:50px"><i class="w3-xxlarge fa fa-map-marker"></i></div>
                        <div class="w3-rest">
                            <input class="w3-input w3-border w3-round-medium" id='location-address'  name="location-address" type="text" placeholder="Address">
                        </div>
                    </div>                    
                    <div class="w3-row w3-section">
                    <div class="w3-col w3-center" style="width:50px"><i class="w3-xxlarge fa fa-map-marker"></i></div>
                        <div class="w3-rest">
                            <input class="w3-input w3-border w3-round-medium" id='location-postalcode'  name="location-postalcode" type="text" placeholder="Postal Code">
                        </div>
                    </div>
                    <div class="w3-row w3-section">
                    <div class="w3-col w3-center" style="width:50px"><i class="w3-xxlarge fa fa-building"></i></div>
                        <div class="w3-rest">
                            <input class="w3-input w3-border w3-round-medium" id='location-city'  name="location-city" type="text" placeholder="City">
                        </div>
                    </div>
                    <div class="w3-row w3-section">
                    <div class="w3-col w3-center" style="width:50px"><i class="w3-xxlarge fa fa-crosshairs"></i></div>
                        <div class="w3-rest">
                            <input class="w3-input w3-border w3-round-medium" id='location-latitude'  name="location-latitude" type="text" placeholder="Latitude">
                        </div>
                    </div>
                    <div class="w3-row w3-section">
                    <div class="w3-col w3-center" style="width:50px"><i class="w3-xxlarge fa fa-crosshairs"></i></div>
                        <div class="w3-rest">
                            <input class="w3-input w3-border w3-round-medium" id='location-longitude'  name="location-longitude" type="text" placeholder="Longitude">
                        </div>
                    </div>

                    <div class="w3-row w3-section">
                    <div class="w3-col w3-center" style="width:50px"><i class="w3-xxlarge fa fa-map"></i></div>
                        <div class="w3-rest">
                            <div id="markerMap" style='width:99%; height:300px;'></div>
                        </div>
                    </div>
                    <input id='location-delete' onclick='displayModal("delete-modal", this);' type='button' class="w3-button w3-right w3-text-teal w3-border w3-margin" value="Delete" style='display: none'></input>
                    <input class="w3-button w3-right w3-text-teal w3-border w3-margin" type="submit" value="Submit">                    
                </form>
              
          </div>
          <div class="w3-third">
              <div id='location-list-placeholder'></div>
          </div>
      </div>

      
    </div>
  </div>

<!-- END MAIN -->
<div id="delete-modal" class="w3-modal">
    <div class="w3-modal-content">
        <div class="w3-container w3-card-4 w3-center w3-text-teal w3-padding-16">
            <h3>Are you sure you want to delete?</h3>
            <input class="w3-button w3-right w3-border" type="submit" value="No" onclick="document.getElementById('delete-modal').style.display = 'none';">
            <input id='delete-btn' class="w3-button w3-left w3-border" type="submit" value="Yes" onclick='deleteLocation();'>
        </div>
    </div>
</div>
</div>

<script>
    var map;
    var marker;
  // Add in the sidebar and navigation bar. These will be common to all pages.
  $(function(){
    $("#sidebar-placeholder").load("static/html/sidebar.html");
    $("#nav-placeholder").load("static/html/navbar.html");
    $("#location-list-placeholder").load("static/html/locationlist.html", function(){
        var locelm = document.getElementById('location-list');        
        locelm.onclick = function(e) {
            e=e||event; // IE sucks
            var target = e.target||e.srcElement; // and sucks again
            if (target && target.getAttribute('id') =='location-elm') {

                var elems = document.getElementsByClassName('location-element');
                for (var ii = 0; ii < elems.length; ++ii) {
                    $(elems[ii]).removeClass('is_active');
                }

                var loc = JSON.parse(target.getAttribute('data-location'));                          
                var name = document.getElementById("location-name");
                name.value = loc.name;            
                name.setAttribute('data-id', loc.location_id);
                document.getElementById("location-description").value = loc.description;
                document.getElementById("location-address").value = loc.address;
                document.getElementById("location-postalcode").value = loc.postal_code;
                document.getElementById("location-city").value = loc.city;
                document.getElementById("location-latitude").value = loc.latitude;
                document.getElementById("location-longitude").value = loc.longitude; 
                if (marker) {
                    marker.setMap(null);
                }

                marker = new google.maps.Marker({
                    position: {lat:loc.latitude, lng:loc.longitude}, 
                    map: map
                });
                document.getElementById('location-header').innerText = 'Edit Location';
                $(target).addClass('is_active');
                document.getElementById('location-header-exit').style.display = 'block';
                document.getElementById('location-delete').style.display = 'block';
                map.setCenter(marker.getPosition());
            }
            return false
        };           
    });
  });  

  function clearedit(){
      document.getElementById('location-header-exit').style.display = 'none';
      document.getElementById('location-delete').style.display = 'none';
      document.getElementById('location-header').innerText = 'Add Location';
      var elems = document.getElementsByClassName('location-element');
      for (var ii = 0; ii < elems.length; ++ii) {
        $(elems[ii]).removeClass('is_active');
      }
      document.getElementById("location-name").removeAttribute('data-id');
  }

    loadScript();
    function loadScript() {
        fetch('/mapskey', {
			method: 'get',
			credentials: "same-origin"			
		}).then(function(response) {
            if (response.status >= 200 && response.status <= 299) {
                response.json().then(function(json){
                    var script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = 'https://maps.googleapis.com/maps/api/js?v=3' + '&key=' + json.map_key +'&callback=initialize'; 
                    document.body.appendChild(script);
                });
            }
        });
    }
    
    function initialize() {
        var myLatlng = new google.maps.LatLng(51.552744, -0.061378);
        var myOptions = {
            zoom: 12,
            center: myLatlng,
            scrollwheel: false,
            clickableIcons: false
        }
        map = new google.maps.Map(document.getElementById("markerMap"), myOptions);

        google.maps.event.addListener(map, 'click', function(event) {
            placeMarker(event.latLng);
        });
    }
    
    function placeMarker(location) {
        if (marker) {
            marker.setMap(null);
        }

        marker = new google.maps.Marker({
            position: location, 
            map: map
        });
        var pos = marker.getPosition();
        document.getElementById('location-latitude').value = pos.lat();
        document.getElementById('location-longitude').value = pos.lng();
        var geocoder = new google.maps.Geocoder;
        geocoder.geocode({'location': pos}, function(results, status) {
          if (status === 'OK') {
            if (results[1]) {
              
              var comp = results[0].address_components;
              for (var ii = 0; ii < comp.length;++ii) {                
                  if (comp[ii].types[0] == 'postal_code') {
                      document.getElementById('location-postalcode').value = comp[ii].long_name;                      
                  }
                  if (comp[ii].types[0] == 'postal_town') {
                      document.getElementById('location-city').value = comp[ii].long_name;                      
                  }
                  if (comp[ii].types[0] == 'route') {
                      document.getElementById('location-address').value = comp[ii].long_name;                      
                  }
              }
              
            } else {
              window.alert('No results found');
            }
          } else {
            window.alert('Geocoder failed due to: ' + status);
          }
        });
    }

    function displayModal(modal, from) {
        var modalElem = document.getElementById(modal);        
        modalElem.style.display = "block";

    }
    window.onclick = function(event) {
        closeModals(event);
    }

    function closeModals(event) {
        var modals = document.getElementsByClassName('w3-modal');
        for(var ii = 0; ii < modals.length; ++ii){
            if (event.target == modals[ii]) {
                modals[ii].style.display = "none";                
            }
        }
    }
    
    function deleteLocation() {
        var formEl = document.getElementById('location-form');
        var id = '';
        for (var i = 0; i < formEl.length; ++i) {
            if (formEl[i].name == "location-name") {
                id = formEl[i].getAttribute('data-id');                
                break;
            }
        }

        deleteEntity('location', id);                
    }
</script>

</body>
</html>